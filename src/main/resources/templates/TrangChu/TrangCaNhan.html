<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trang Cá Nhân</title>
    <link href="/css/style.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
</head>
<body>

<header>
    <h1>Thông Tin Cá Nhân</h1>
</header>

<main>
    <!-- Hiển thị thông báo thành công/lỗi -->
    <div class="alert alert-success" th:if="${param.success}">
        Cập nhật thông tin thành công!
    </div>
    <div class="alert alert-danger" th:if="${param.error}">
        <span th:switch="${param.error}">
            <span th:case="'not_logged_in'">Vui lòng đăng nhập để tiếp tục.</span>
            <span th:case="'user_not_found'">Không tìm thấy người dùng.</span>
            <span th:case="'save_failed'">Lưu thông tin thất bại. Vui lòng thử lại.</span>
            <span th:case="*">Đã có lỗi xảy ra: <span th:text="${param.error}"></span></span>
        </span>
    </div>

    <!-- Mục Hồ Sơ Cá Nhân -->
    <section class="profile-section">
        <h2><i class="fas fa-user"></i> Hồ Sơ Cá Nhân</h2>
        <form th:action="@{/LuuThongTinCaNhan}" th:method="post">
            <div class="form-group">
                <label><strong>ID:</strong></label>
                <span th:text="${user.id}"></span>
            </div>

            <div class="form-group">
                <label><strong>Họ và Tên:</strong></label>
                <input autocomplete="off" name="firstName" placeholder="Nhập Họ" required th:value="${user.firstName}"
                       type="text">
                <input autocomplete="off" name="lastName" placeholder="Nhập Tên" required th:value="${user.lastName}"
                       type="text">
            </div>

            <div class="form-group">
                <label><strong>Email:</strong></label>
                <input autocomplete="off" name="email" placeholder="Nhập Email" required th:value="${user.email}"
                       type="email">
            </div>

            <div class="form-group">
                <label><strong>Số Điện Thoại:</strong></label>
                <input autocomplete="off" name="phoneNumber" placeholder="Nhập Số Điện Thoại" required
                       th:value="${user.phoneNumber}" type="text">
            </div>

            <button type="submit"><i class="fas fa-save"></i> Lưu</button>
        </form>
    </section>

    <!-- Mục Đăng Ký Khuôn Mặt -->
    <section class="face-registration-section">
        <h2><i class="fas fa-camera"></i> Đăng Ký Khuôn Mặt</h2>
        <form th:action="@{/DangKyKhuonMat}" th:method="post">
            <video autoplay height="240" id="video" style="transform: scaleX(-1);" width="320"></video>
            <button onclick="toggleCamera()" type="button">Bật/Tắt Camera</button>
            <button onclick="captureFace()" type="button">Chụp Khuôn Mặt</button>
            <input id="faceData" name="faceData" type="hidden">
            <span id="captureStatus" style="color: green; display: none;">Đã chụp khuôn mặt!</span>
            <button type="submit"><i class="fas fa-upload"></i> Đăng Ký</button>
        </form>
    </section>

    <!-- Mục Bảo Mật -->
    <section class="password-section">
        <h2><i class="fas fa-key"></i> Bảo Mật</h2>
        <a class="btn btn-warning" href="/DoiMatKhau"><i class="fas fa-lock"></i> Đổi Mật Khẩu</a>
    </section>

    <!-- Điều Hướng -->
    <section class="navigation-section">
        <a class="btn" th:href="@{/redirect}"><i class="fas fa-home"></i> Quay về Trang Chủ</a>
        <a class="btn btn-danger" href="/DangXuat"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a>
    </section>
</main>

<script>
    let video = document.getElementById('video');
    let captureStatus = document.getElementById('captureStatus');
    let stream = null;

    function startCamera() {
        navigator.mediaDevices.getUserMedia({video: {facingMode: 'user'}})
            .then(function (videoStream) {
                stream = videoStream;
                video.srcObject = stream;
            })
            .catch(function (err) {
                console.log("Lỗi webcam: " + err);
                alert("Không thể truy cập webcam: " + err.message);
            });
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function toggleCamera() {
        if (video.srcObject) {
            stopCamera();
        } else {
            startCamera();
        }
    }

    function captureFace() {
        let canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        let context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        let faceData = canvas.toDataURL('image/png');
        document.getElementById('faceData').value = faceData;
        captureStatus.style.display = 'inline';
        setTimeout(() => captureStatus.style.display = 'none', 2000);
    }
</script>

<style>
    .alert {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>

</body>
</html>