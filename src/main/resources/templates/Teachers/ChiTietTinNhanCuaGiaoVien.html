<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Ti·∫øt Tin Nh·∫Øn C·ªßa Gi√°o Vi√™n</title>
    <link rel="stylesheet" href="/ChiTietTinNhanCuaGiaoVien.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container">
    <h2>Chi Ti·∫øt Tin Nh·∫Øn</h2>

    <!-- N√∫t quay v·ªÅ trang ch·ªß -->
    <div class="back-button">
        <a href="/TrangChuGiaoVien" class="btn btn-primary">Quay v·ªÅ Trang Ch·ªß</a>
    </div>

    <!-- Hi·ªÉn th·ªã danh s√°ch tin nh·∫Øn -->
    <div id="messagesContainer">
        <div th:each="message : ${messages}"
             class="message-box"
             th:classappend="${message.sender != null and message.sender.getId() == teacher.id} ? 'right' : 'left'">
            <div class="message-header">
                <span th:text="${message.sender != null and message.sender.getId() != null ?
                    (message.sender.getId() == teacher.id ? 'Gi√°o vi√™n: ' + message.sender.getId()
                    : 'H·ªçc sinh: ' + message.sender.getId()) : 'Kh√¥ng x√°c ƒë·ªãnh'}">
                </span>
            </div>
            <div class="message-time" th:text="${#temporals.format(message.datetime, 'dd/MM/yyyy HH:mm')}"></div>
            <div class="message-text" th:text="${message.text}"></div>
        </div>
    </div>

    <!-- Form g·ª≠i tin nh·∫Øn -->
    <div class="message-form">
        <h3>G·ª≠i tin nh·∫Øn m·ªõi</h3>
        <form id="messageForm">
            <input type="hidden" id="studentID" th:value="${student.id}" />
            <input type="hidden" id="teacherID" th:value="${teacher.id}" />
            <textarea id="messageText" placeholder="Nh·∫≠p tin nh·∫Øn..." required></textarea>
            <button type="submit">G·ª≠i</button>
        </form>
    </div>
</div>

<script>
    var socket = new SockJS("/ws"); // K·∫øt n·ªëi WebSocket
    var stompClient = Stomp.over(socket);

    stompClient.connect({}, function (frame) {
        console.log("‚úÖ K·∫øt n·ªëi WebSocket th√†nh c√¥ng:", frame);

        // L·∫Øng nghe tin nh·∫Øn t·ª´ ng∆∞·ªùi nh·∫≠n
        stompClient.subscribe("/user/queue/messages", function (message) {
            var receivedMessage = JSON.parse(message.body);
            console.log("üì© Nh·∫≠n tin nh·∫Øn:", receivedMessage);

            appendMessage(receivedMessage.senderId, receivedMessage.content);
        });
    });

    $("#messageForm").on("submit", function (event) {
        event.preventDefault(); // NgƒÉn ch·∫∑n reload trang

        var senderId = $("#teacherID").val();
        var messageContent = $("#messageText").val();

        var message = {
            senderId: senderId,
            recipientId: $("#studentID").val(),
            content: messageContent
        };

        stompClient.send("/app/chat", {}, JSON.stringify(message)); // G·ª≠i tin nh·∫Øn l√™n server

        // üöÄ Hi·ªÉn th·ªã ngay tin nh·∫Øn tr√™n giao di·ªán m√† kh√¥ng c·∫ßn ch·ªù ph·∫£n h·ªìi
        appendMessage(senderId, messageContent);

        $("#messageText").val(""); // X√≥a n·ªôi dung input
    });



    // ‚úÖ H√†m th√™m tin nh·∫Øn v√†o giao di·ªán v√† t·ª± ƒë·ªông cu·ªôn xu·ªëng
    function appendMessage(senderId, content) {
        var sender = senderId === $("#teacherID").val() ? "Gi√°o vi√™n" : "H·ªçc sinh";

        var messageHTML = `
            <div class="message-box ${sender === 'Gi√°o vi√™n' ? 'right' : 'left'}">
                <div class="message-header">${sender}: ${senderId}</div>
                <div class="message-time">${new Date().toLocaleString()}</div>
                <div class="message-text">${content}</div>
            </div>
        `;

        $("#messagesContainer").append(messageHTML);
        scrollToBottom();
    }

    // ‚úÖ Cu·ªôn xu·ªëng tin nh·∫Øn m·ªõi nh·∫•t
    function scrollToBottom() {
        $("#messagesContainer").scrollTop($("#messagesContainer")[0].scrollHeight);
    }
</script>


</body>
</html>
